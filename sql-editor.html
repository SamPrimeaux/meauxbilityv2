<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SQL Editor - MeauxDev - Meaux Access</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #1F97A9;
      --primary-light: #26B4C9;
      --accent: #FF7619;
      --bg-dark: #0f172a;
      --bg-medium: #1e293b;
      --bg-light: #334155;
      --glass: rgba(139, 149, 168, 0.1);
      --glass-border: rgba(139, 149, 168, 0.2);
      --text-light: #f1f5f9;
      --text-secondary: #94a3b8;
      --success: #10b981;
      --error: #ef4444;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-medium) 50%, var(--bg-light) 100%);
      color: var(--text-light);
      min-height: 100vh;
      line-height: 1.6;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, rgba(139, 149, 168, 0.1) 0%, rgba(139, 149, 168, 0.05) 100%);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--glass-border);
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .sidebar-toggle {
      background: none;
      border: none;
      color: var(--text-light);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 8px;
      transition: background 0.3s;
    }

    .sidebar-toggle:hover {
      background: var(--glass);
    }

    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-light);
    }

    .search-bar {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 0.5rem 1rem;
      min-width: 300px;
    }

    .search-bar input {
      background: none;
      border: none;
      color: var(--text-light);
      flex: 1;
      outline: none;
    }

    .search-bar input::placeholder {
      color: var(--text-secondary);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .theme-toggle,
    .notifications,
    .user-menu {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 0.5rem;
      cursor: pointer;
      transition: all 0.3s;
    }

    .theme-toggle:hover,
    .notifications:hover,
    .user-menu:hover {
      background: rgba(139, 149, 168, 0.2);
      transform: translateY(-2px);
    }

    /* Dashboard Container */
    .dashboard-container {
      display: flex;
      min-height: calc(100vh - 70px);
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: linear-gradient(135deg, rgba(139, 149, 168, 0.1) 0%, rgba(139, 149, 168, 0.05) 100%);
      backdrop-filter: blur(20px);
      border-right: 1px solid var(--glass-border);
      padding: 2rem 0;
      overflow-y: auto;
      position: sticky;
      top: 70px;
      height: calc(100vh - 70px);
    }

    .nav-section {
      margin-bottom: 2rem;
    }

    .nav-section-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-secondary);
      padding: 0 1.5rem;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1.5rem;
      color: var(--text-secondary);
      text-decoration: none;
      transition: all 0.3s;
      border-left: 3px solid transparent;
    }

    .nav-link:hover {
      background: var(--glass);
      color: var(--text-light);
    }

    .nav-link.active {
      background: var(--glass);
      color: var(--primary-light);
      border-left-color: var(--primary-light);
    }

    .nav-icon {
      width: 20px;
      height: 20px;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
    }

    .page-header {
      margin-bottom: 2rem;
    }

    .page-header h1 {
      font-size: 2.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 0.5rem;
    }

    .card {
      background: linear-gradient(135deg, rgba(139, 149, 168, 0.1) 0%, rgba(139, 149, 168, 0.05) 100%);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .sql-toolbar {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .CodeMirror {
      height: 300px;
      border-radius: 12px;
      font-size: 14px;
    }

    .sql-editor {
      width: 100%;
      min-height: 300px;
      background: var(--bg-dark);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 1rem;
      color: var(--text-light);
      font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.6;
      resize: vertical;
      outline: none;
    }

    .sql-editor:focus {
      border-color: var(--primary-light);
      box-shadow: 0 0 0 3px rgba(31, 151, 169, 0.1);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 20px rgba(31, 151, 169, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(31, 151, 169, 0.4);
    }

    .btn-secondary {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      color: var(--text-light);
      padding: 0.75rem 1.5rem;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-secondary:hover {
      background: rgba(139, 149, 168, 0.2);
    }

    select {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      color: var(--text-light);
      padding: 0.75rem 1rem;
      border-radius: 12px;
      outline: none;
      cursor: pointer;
      min-width: 250px;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .results-container {
      margin-top: 2rem;
    }

    .results-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--bg-dark);
      border-radius: 12px;
      overflow: hidden;
    }

    .results-table th {
      background: var(--bg-medium);
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid var(--glass-border);
      position: sticky;
      top: 0;
    }

    .results-table td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--glass-border);
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 13px;
    }

    .results-table tr:hover {
      background: var(--glass);
    }

    .query-info {
      display: flex;
      gap: 2rem;
      padding: 1rem;
      background: var(--glass);
      border-radius: 12px;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }

    .query-info span {
      color: var(--text-secondary);
    }

    .query-info strong {
      color: var(--primary-light);
    }

    .error-message {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--error);
      color: var(--error);
      padding: 1rem;
      border-radius: 12px;
      margin-top: 1rem;
    }

    .success-message {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid var(--success);
      color: var(--success);
      padding: 1rem;
      border-radius: 12px;
      margin-top: 1rem;
    }

    .query-templates {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .template-btn {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      color: var(--text-light);
      padding: 0.75rem 1rem;
      border-radius: 12px;
      cursor: pointer;
      text-align: left;
      font-size: 0.85rem;
      transition: all 0.3s;
    }

    .template-btn:hover {
      background: rgba(139, 149, 168, 0.2);
      border-color: var(--primary-light);
    }
  </style>
</head>

<body>
  <header class="header">
    <div class="header-left">
      <button class="sidebar-toggle" aria-label="Toggle menu">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="3" y1="6" x2="21" y2="6" />
          <line x1="3" y1="12" x2="21" y2="12" />
          <line x1="3" y1="18" x2="21" y2="18" />
        </svg>
      </button>
      <div class="logo">Meaux Access</div>
      <div class="search-bar">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8" />
          <path d="m21 21-4.35-4.35" />
        </svg>
        <input type="text" placeholder="Search queries, databases...">
      </div>
    </div>
    <div class="header-right">
      <button class="theme-toggle" aria-label="Change theme">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="5" />
          <line x1="12" y1="1" x2="12" y2="3" />
          <line x1="12" y1="21" x2="12" y2="23" />
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
          <line x1="1" y1="12" x2="3" y2="12" />
          <line x1="21" y1="12" x2="23" y2="12" />
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
        </svg>
      </button>
      <button class="notifications" aria-label="Notifications">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
          <path d="M13.73 21a2 2 0 0 1-3.46 0" />
        </svg>
      </button>
      <button class="user-menu" aria-label="User menu">D</button>
    </div>
  </header>

  <div class="dashboard-container">
    <aside class="sidebar">
      <nav>
        <div class="nav-section">
          <div class="nav-section-title">MeauxWork</div>
          <a href="/dashboard" class="nav-link">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="7" height="7" />
              <rect x="14" y="3" width="7" height="7" />
              <rect x="14" y="14" width="7" height="7" />
              <rect x="3" y="14" width="7" height="7" />
            </svg>
            Overview
          </a>
          <a href="/dashboard/apps" class="nav-link">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
              <line x1="3" y1="9" x2="21" y2="9" />
              <line x1="9" y1="21" x2="9" y2="9" />
            </svg>
            Projects
          </a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">MeauxApps</div>
          <a href="/dashboard/apps" class="nav-link">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="7" height="7" />
              <rect x="14" y="3" width="7" height="7" />
              <rect x="14" y="14" width="7" height="7" />
              <rect x="3" y="14" width="7" height="7" />
            </svg>
            All Apps
          </a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">MeauxDev</div>
          <a href="/dashboard/dev/sql" class="nav-link active">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
              <polyline points="14 2 14 8 20 8" />
              <line x1="16" y1="13" x2="8" y2="13" />
              <line x1="16" y1="17" x2="8" y2="17" />
              <polyline points="10 9 9 9 8 9" />
            </svg>
            SQL Editor
          </a>
        </div>
      </nav>
    </aside>

    <main class="main-content">
      <div class="page-header">
        <h1>SQL Editor</h1>
        <p style="color: var(--text-secondary);">Query your D1 databases safely with real-time execution</p>
      </div>

      <div class="card">
        <h3 style="margin-bottom: 1rem; color: var(--primary-light);">Quick Templates</h3>
        <div class="query-templates">
          <button class="template-btn"
            onclick="loadTemplate('SELECT * FROM projects ORDER BY created_at DESC LIMIT 10')">List Projects</button>
          <button class="template-btn"
            onclick="loadTemplate('SELECT name, COUNT(*) as count FROM sqlite_master WHERE type=\\'table\\' GROUP BY name')">Show
            Tables</button>
          <button class="template-btn" onclick="loadTemplate('PRAGMA table_info(projects)')">Table Schema</button>
          <button class="template-btn"
            onclick="loadTemplate('SELECT * FROM meta_tags WHERE is_active = 1 LIMIT 10')">Active Meta Tags</button>
          <button class="template-btn"
            onclick="loadTemplate('SELECT project_id, COUNT(*) as tag_count FROM meta_tags GROUP BY project_id')">Tags
            by
            Project</button>
          <button class="template-btn"
            onclick="loadTemplate('SELECT * FROM project_activity ORDER BY created_at DESC LIMIT 20')">Recent
            Activity</button>
        </div>
      </div>

      <div class="card">
        <div class="sql-toolbar">
          <select id="database-select">
            <option value="613e4fe1-94f3-4aa1-8dfc-7f321d3bc46f">üìä meauxbility-dashboard-db (Primary)</option>
            <option value="f01e1fbb-01fb-4900-80e9-bbb90db51bbe">üìà analytics-db (30.8k queries)</option>
            <option value="ee3e3adb-da99-457d-8c2c-390ff19f6435">üë§ user-data-db (2.53 MB)</option>
            <option value="df192326-00b4-4d68-ad0d-5dd439dc8898">üì¶ secondary-db (543 queries)</option>
          </select>
          <div class="checkbox-group">
            <input type="checkbox" id="read-only" checked>
            <label for="read-only" style="color: var(--text-secondary);">Read-only mode (safer)</label>
          </div>
          <button class="btn-primary" onclick="executeQuery()">‚ñ∂ Run Query (Ctrl+Enter)</button>
          <button class="btn-secondary" onclick="clearEditor()">Clear</button>
          <button class="btn-secondary" onclick="exportResults()">Export CSV</button>
        </div>

        <textarea id="sql-editor" class="sql-editor"
          placeholder="-- Enter your SQL query here&#10;-- Press Ctrl+Enter to execute&#10;&#10;SELECT * FROM projects LIMIT 10;"></textarea>

        <div id="query-info" class="query-info" style="display: none;">
          <span>‚ö° Execution: <strong id="exec-time">-</strong></span>
          <span>üìä Rows: <strong id="row-count">-</strong></span>
          <span>üóÑÔ∏è Database: <strong id="db-name">-</strong></span>
        </div>

        <div id="error-message" class="error-message" style="display: none;"></div>
        <div id="success-message" class="success-message" style="display: none;"></div>
      </div>

      <div id="results-container" class="results-container" style="display: none;">
        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2>Query Results</h2>
            <button class="btn-secondary" onclick="exportResults()">Export as CSV</button>
          </div>
          <div style="overflow-x: auto; max-height: 600px; overflow-y: auto;">
            <table id="results-table" class="results-table"></table>
          </div>
        </div>
      </div>
    </main>

    <script>
      const API_BASE = '/api';
      let currentResults = [];

      async function executeQuery() {
        const editor = document.getElementById('sql-editor');
        const query = editor.value.trim();
        const databaseId = document.getElementById('database-select').value;
        const readOnly = document.getElementById('read-only').checked;

        if (!query) {
          showError('Please enter a SQL query');
          return;
        }

        // Hide previous results/errors
        document.getElementById('results-container').style.display = 'none';
        document.getElementById('error-message').style.display = 'none';
        document.getElementById('success-message').style.display = 'none';
        document.getElementById('query-info').style.display = 'none';

        try {
          const response = await fetch(API_BASE + '/sql/query', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              query: query,
              database_id: databaseId,
              read_only: readOnly
            })
          });

          const data = await response.json();

          if (data.success) {
            showSuccess('‚úì Query executed successfully');
            displayResults(data.result, data.meta, data.execution_time_ms, data.row_count);
            document.getElementById('db-name').textContent = document.getElementById('database-select').selectedOptions[0].text;
            currentResults = data.result;
          } else {
            showError('‚ùå ' + (data.error || 'Query failed'));
          }
        } catch (error) {
          showError('‚ùå Network error: ' + error.message);
        }
      }

      function displayResults(results, meta, execTime, rowCount) {
        const container = document.getElementById('results-container');
        const table = document.getElementById('results-table');
        const info = document.getElementById('query-info');

        if (!results || results.length === 0) {
          table.innerHTML = '<tr><td colspan="100%" style="text-align: center; padding: 2rem; color: var(--text-secondary);">‚úì Query executed but returned no results</td></tr>';
          container.style.display = 'block';
          info.style.display = 'flex';
          document.getElementById('exec-time').textContent = execTime + 'ms';
          document.getElementById('row-count').textContent = '0';
          return;
        }

        // Get column names from first row
        const columns = Object.keys(results[0]);

        // Build table header
        let html = '<thead><tr>';
        columns.forEach(col => {
          html += `<th>${escapeHtml(col)}</th>`;
        });
        html += '</tr></thead><tbody>';

        // Build table rows
        results.forEach((row, idx) => {
          html += '<tr>';
          columns.forEach(col => {
            const value = row[col];
            let displayValue;
            if (value === null || value === undefined) {
              displayValue = '<em style="color: var(--text-secondary); opacity: 0.5;">NULL</em>';
            } else if (typeof value === 'object') {
              displayValue = '<code>' + escapeHtml(JSON.stringify(value)) + '</code>';
            } else {
              displayValue = escapeHtml(String(value));
            }
            html += `<td>${displayValue}</td>`;
          });
          html += '</tr>';
        });

        html += '</tbody>';
        table.innerHTML = html;

        // Show info
        info.style.display = 'flex';
        document.getElementById('exec-time').textContent = execTime + 'ms';
        document.getElementById('row-count').textContent = rowCount;

      container.style.display = 'block';
    }

    // Sidebar toggle
    document.querySelector('.sidebar-toggle')?.addEventListener('click', () => {
      document.body.classList.toggle('sidebar-open');
    });

    // Theme toggle
    document.querySelector('.theme-toggle')?.addEventListener('click', () => {
      document.body.classList.toggle('theme-dark');
      localStorage.setItem('theme', document.body.classList.contains('theme-dark') ? 'dark' : 'light');
    });

    // Load saved theme
    if (localStorage.getItem('theme') === 'dark') {
      document.body.classList.add('theme-dark');
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function showError(message) {
        const el = document.getElementById('error-message');
        el.textContent = message;
        el.style.display = 'block';
      }

      function showSuccess(message) {
        const el = document.getElementById('success-message');
        el.textContent = message;
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 3000);
      }

      function clearEditor() {
        document.getElementById('sql-editor').value = '';
        document.getElementById('results-container').style.display = 'none';
        document.getElementById('error-message').style.display = 'none';
        document.getElementById('query-info').style.display = 'none';
      }

      function loadTemplate(query) {
        document.getElementById('sql-editor').value = query;
        document.getElementById('sql-editor').focus();
      }

      function exportResults() {
        if (!currentResults || currentResults.length === 0) {
          showError('No results to export');
          return;
        }

        const columns = Object.keys(currentResults[0]);
        let csv = columns.join(',') + '\n';

        currentResults.forEach(row => {
          const values = columns.map(col => {
            const value = row[col];
            if (value === null || value === undefined) return '';
            if (typeof value === 'object') return JSON.stringify(value);
            return String(value).replace(/"/g, '""');
          });
          csv += values.map(v => `"${v}"`).join(',') + '\n';
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'query-results-' + Date.now() + '.csv';
        a.click();
        URL.revokeObjectURL(url);
        showSuccess('‚úì Results exported to CSV');
      }

      // Keyboard shortcut: Ctrl+Enter to execute
      document.getElementById('sql-editor').addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 'Enter') {
          e.preventDefault();
          executeQuery();
        }
    });
  </script>
  <footer class="footer" style="background: linear-gradient(135deg, rgba(139, 149, 168, 0.1) 0%, rgba(139, 149, 168, 0.05) 100%); backdrop-filter: blur(20px); border-top: 1px solid var(--glass-border); padding: 2rem; text-align: center; color: var(--text-secondary); font-size: 0.9rem;">
    <p>&copy; 2025 Meauxbility. All rights reserved.</p>
  </footer>
</body>

</html>