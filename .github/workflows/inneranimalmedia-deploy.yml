name: Deploy Inner Animal Media - Cloudflare + GitHub Pages

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "main" ]
    paths:
      - 'src/inneranimalmedia.js'
      - 'wrangler.inneranimalmedia.jsonc'
      - '*.html'
      - '.github/workflows/inneranimalmedia-deploy.yml'
  pull_request:
    branches: [ "main" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # Deploy to Cloudflare Workers (.dev URL)
  deploy-cloudflare:
    name: Deploy to Cloudflare Workers
    runs-on: ubuntu-latest
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy Worker
        run: |
          wrangler deploy --config wrangler.inneranimalmedia.jsonc

      - name: Upload HTML pages to R2
        run: |
          export CLOUDFLARE_API_TOKEN="${{ secrets.CLOUDFLARE_API_TOKEN }}"
          
          # Upload main index page - this is the landing page served at /
          if [ -f "inneranimalmedia-index.html" ]; then
            echo "ğŸ“„ Uploading index page to R2..."
            wrangler r2 object put "inneranimalmedia/inner-animal-media-public-facing-design (1).html" \
              --file=inneranimalmedia-index.html \
              --content-type="text/html;charset=UTF-8" \
              --remote && echo "âœ… Index page uploaded" || echo "âš ï¸ Index file upload failed"
          else
            echo "âš ï¸ Warning: inneranimalmedia-index.html not found - index page may not work"
          fi
          
          # Upload index page
          if [ -f "inneranimalmedia-index.html" ]; then
            echo "ğŸ“„ Uploading index page to R2..."
            wrangler r2 object put inneranimalmedia/inneranimalmedia-index.html \
              --file=inneranimalmedia-index.html \
              --content-type="text/html;charset=UTF-8" \
              --remote && echo "âœ… Index page uploaded" || echo "âš ï¸ Index page upload failed"
          fi
          
          # Upload projects page
          if [ -f "inneranimalmedia-projects.html" ]; then
            echo "ğŸ“„ Uploading projects page to R2..."
            wrangler r2 object put inneranimalmedia/inneranimalmedia-projects.html \
              --file=inneranimalmedia-projects.html \
              --content-type="text/html;charset=UTF-8" \
              --remote && echo "âœ… Projects page uploaded" || echo "âš ï¸ Projects page upload failed"
          fi
          
          # Upload agents page
          if [ -f "inneranimalmedia-agents.html" ]; then
            echo "ğŸ“„ Uploading agents page to R2..."
            wrangler r2 object put inneranimalmedia/inneranimalmedia-agents.html \
              --file=inneranimalmedia-agents.html \
              --content-type="text/html;charset=UTF-8" \
              --remote && echo "âœ… Agents page uploaded" || echo "âš ï¸ Agents page upload failed"
          fi
          
          # Upload repos page
          if [ -f "inneranimalmedia-repos.html" ]; then
            echo "ğŸ“„ Uploading repos page to R2..."
            wrangler r2 object put inneranimalmedia/inneranimalmedia-repos.html \
              --file=inneranimalmedia-repos.html \
              --content-type="text/html;charset=UTF-8" \
              --remote && echo "âœ… Repos page uploaded" || echo "âš ï¸ Repos page upload failed"
          fi
          
          # Upload workers page
          if [ -f "inneranimalmedia-workers.html" ]; then
            echo "ğŸ“„ Uploading workers page to R2..."
            wrangler r2 object put inneranimalmedia/inneranimalmedia-workers.html \
              --file=inneranimalmedia-workers.html \
              --content-type="text/html;charset=UTF-8" \
              --remote && echo "âœ… Workers page uploaded" || echo "âš ï¸ Workers page upload failed"
          fi
          
          # Upload dashboard page
          if [ -f "inneranimalmedia-dashboard.html" ]; then
            echo "ğŸ“„ Uploading dashboard page to R2..."
            wrangler r2 object put inneranimalmedia/inneranimalmedia-dashboard.html \
              --file=inneranimalmedia-dashboard.html \
              --content-type="text/html;charset=UTF-8" \
              --remote && echo "âœ… Dashboard page uploaded" || echo "âš ï¸ Dashboard page upload failed"
          fi
          
          # Upload shared navigation script (if needed)
          if [ -f "shared-nav.js" ]; then
            echo "ğŸ“„ Uploading shared navigation script to R2..."
            wrangler r2 object put inneranimalmedia/shared-nav.js \
              --file=shared-nav.js \
              --content-type="application/javascript;charset=UTF-8" \
              --remote && echo "âœ… Shared nav script uploaded" || echo "âš ï¸ Shared nav script upload failed"
          fi
          
          # Upload dashboard and module pages
          echo "ğŸ“¦ Uploading dashboard and module pages..."
          for file in MEAUXGLOBE.html meaux-team.html meaux-doc.html meaux-photo.html meaux-memories.html meaux-media.html meaux-cloud.html meaux-cad.html meaux-learn.html; do
            if [ -f "$file" ]; then
              echo "  â†’ Uploading $file..."
              wrangler r2 object put inneranimalmedia/$file \
                --file=$file \
                --content-type="text/html;charset=UTF-8" \
                --remote && echo "    âœ… $file uploaded" || echo "    âš ï¸ $file upload failed"
            else
              echo "  âš ï¸ $file not found, skipping"
            fi
          done
          
          # Upload public-facing pages
          echo "ğŸ“„ Uploading public pages..."
          for file in about.html contact.html services.html work.html community.html start-project.html; do
            if [ -f "$file" ]; then
              echo "  â†’ Uploading $file..."
              wrangler r2 object put inneranimalmedia/$file \
                --file=$file \
                --content-type="text/html;charset=UTF-8" \
                --remote && echo "    âœ… $file uploaded" || echo "    âš ï¸ $file upload failed"
            fi
          done
          
          echo ""
          echo "âœ… Asset upload complete! All HTML pages uploaded to R2 bucket 'inneranimalmedia'"

      - name: Verify Cloudflare Deployment
        run: |
          echo "âœ… Cloudflare Worker deployed!"
          echo "ğŸŒ .dev URL: https://inneranimalmedia.meauxbility.workers.dev"
          echo "ğŸ“¦ R2 Public URL: https://pub-09a1e1c040e743e48cfb5dd59e91b61a.r2.dev"

  # Deploy to GitHub Pages (github.io URL)
  deploy-github-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: deploy-cloudflare
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Prepare GitHub Pages content
        run: |
          # Copy redirect file as index.html for GitHub Pages
          cp github-pages-index.html index.html
          echo "âœ… Prepared GitHub Pages redirect"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Verify GitHub Pages Deployment
        run: |
          echo "âœ… GitHub Pages deployed!"
          echo "ğŸŒ GitHub Pages URL: https://samprimeaux.github.io/inneranimalmedia/"
          echo "ğŸ”— Redirects to: https://inneranimalmedia.meauxbility.workers.dev"

  # Summary
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-cloudflare, deploy-github-pages]
    if: always()

    steps:
      - name: Print Summary
        run: |
          echo "ğŸš€ Deployment Complete!"
          echo ""
          echo "âœ… Cloudflare Workers (.dev):"
          echo "   https://inneranimalmedia.meauxbility.workers.dev"
          echo ""
          echo "âœ… GitHub Pages (github.io):"
          echo "   https://samprimeaux.github.io/inneranimalmedia/"
          echo ""
          echo "ğŸ“¦ R2 Public URL:"
          echo "   https://pub-09a1e1c040e743e48cfb5dd59e91b61a.r2.dev"
          echo ""
          echo "ğŸ‰ Both URLs are live and functional!"
