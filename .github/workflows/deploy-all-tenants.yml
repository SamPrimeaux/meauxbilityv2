name: Deploy All Tenants

on:
  push:
    branches: [main]
    paths:
      - 'tenants/**'
      - 'src/tenant-router.js'
      - '.github/workflows/deploy-all-tenants.yml'
  workflow_dispatch:

jobs:
  deploy-tenants:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        tenant:
          - inneranimalmedia
          - southernpets
          - meauxlearn
          - fuelnfreetime
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy ${{ matrix.tenant }} Worker
        run: |
          if [ -f "tenants/${{ matrix.tenant }}/wrangler.jsonc" ]; then
            wrangler deploy --config tenants/${{ matrix.tenant }}/wrangler.jsonc
          elif [ -f "wrangler.${{ matrix.tenant }}.jsonc" ]; then
            wrangler deploy --config wrangler.${{ matrix.tenant }}.jsonc
          else
            echo "No config found for ${{ matrix.tenant }}, skipping..."
          fi

      - name: Verify Deployment
        run: |
          echo "‚úÖ Tenant ${{ matrix.tenant }} deployed"
          echo "üåê URL: https://${{ matrix.tenant }}.meauxbility.workers.dev"
